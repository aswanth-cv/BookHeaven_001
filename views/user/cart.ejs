<%- include("../partials/user/header") %>
<style>
  /* Existing styles */
  .offer-badge {
    display: inline-block;
    background-color: #e53935;
    color: white;
    padding: 0.15rem 0.5rem;
    font-size: 0.75rem;
    font-weight: 600;
    border-radius: 2px;
    margin-left: 0.5rem;
  }
  
  .offer-title {
    font-size: 0.75rem;
    color: #4caf50;
  }

  .original-price {
    text-decoration: line-through;
    color: #6b7280;
    font-size: 0.875rem;
    margin-right: 0.5rem;
  }

  .discounted-price {
    color: #000;
    font-weight: bold;
  }

  /* Spinner styles */
  .cart-item.updating {
    opacity: 0.7;
    pointer-events: none;
    position: relative;
  }

  .cart-item.updating::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 24px;
    height: 24px;
    border: 3px solid #000;
    border-top: 3px solid transparent;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    transform: translate(-50%, -50%);
    z-index: 10;
  }

  @keyframes spin {
    0% { transform: translate(-50%, -50%) rotate(0deg); }
    100% { transform: translate(-50%, -50%) rotate(360deg); }
  }
</style>
<!-- Cart Header Section -->
<section class="py-5 bg-light">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-8 text-center">
        <h1 class="display-5 fw-bold mb-2">Your Cart</h1>
        <p class="text-muted mb-0">Review and modify your selected stories</p>
      </div>
    </div>
  </div>
</section>

<!-- Cart Content Section -->
<section class="py-5">
  <div class="container">
    <!-- Error/Success Messages -->
    <% if (typeof errorMessage !== 'undefined' && errorMessage) { %>
      <div class="row justify-content-center mb-4">
        <div class="col-lg-10">
          <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="ri-error-warning-line me-2"></i>
            <strong>Stock Update:</strong> <%= errorMessage.replace(/\n/g, '<br>') %>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        </div>
      </div>
    <% } %>
    
    <% if (typeof successMessage !== 'undefined' && successMessage) { %>
      <div class="row justify-content-center mb-4">
        <div class="col-lg-10">
          <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="ri-check-line me-2"></i>
            <%= successMessage %>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        </div>
      </div>
    <% } %>
    
    <div class="row g-5">
      <!-- Cart Items -->
      <div class="col-lg-8">
        <!-- Empty Cart State -->
        <div class="empty-cart text-center py-5 <%= cartItems.length === 0 ? '' : 'd-none' %>">
          <div class="mb-4">
            <i class="ri-shopping-cart-line" style="font-size: 4rem; color: #ccc;"></i>
          </div>
          <h3 class="fs-4 fw-semibold mb-3">Your cart is empty</h3>
          <p class="text-muted mb-4">Looks like you haven't found your story yet</p>
          <a href="/shopPage" class="btn btn-dark px-4 py-2">Continue Shopping</a>
        </div>

        <!-- Cart Items List -->
        <div class="cart-items <%= cartItems.length === 0 ? 'd-none' : '' %>">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="fs-4 fw-bold">Items (<%= cartItems.reduce((sum, item) => sum + item.quantity, 0) %>)</h2>
            <button class="btn btn-link text-dark p-0 text-decoration-none" id="clearCartBtn">Clear Cart</button>
          </div>

          <% cartItems.forEach(item => { %>
            <div class="cart-item bg-white p-4 mb-3 rounded shadow-sm" data-product-id="<%= item.product._id %>">
              <div class="row align-items-center">
                <div class="col-md-2 col-4 mb-3 mb-md-0">
                  <div class="position-relative">
                    <img src="<%= item.product.mainImage || '/api/placeholder/150/200?type=book' %>" alt="<%= item.product.title %>" class="img-fluid rounded" />
                    <% if (item.product.activeOffer && item.product.discountPercentage > 0) { %>
                      <span class="position-absolute top-0 end-0 offer-badge"><%= item.product.discountPercentage %>% OFF</span>
                    <% } %>
                  </div>
                </div>
                <div class="col-md-6 col-8 mb-3 mb-md-0">
                  <h3 class="fs-5 fw-semibold mb-1"><%= item.product.title %></h3>
                  <p class="text-muted small mb-1"><%= item.product.author %></p>
                  <p class="small mb-0"><%= item.product.format || 'Hardcover' %></p>
                  <% if (item.product.activeOffer) { %>
                    <p class="offer-title mt-1"><i class="ri-price-tag-3-line"></i> <%= item.product.activeOffer.title %></p>
                  <% } %>
                  <span class="stock-status <%= item.product.stock > 10 ? 'in-stock' : item.product.stock > 0 ? 'low-stock' : 'out-of-stock' %>">
                    <i class="ri-<%= item.product.stock > 10 ? 'checkbox-circle-line' : item.product.stock > 0 ? 'alert-line' : 'close-circle-line' %> me-1"></i>
                    <%= item.product.stock > 10 ? `In Stock (${item.product.stock} copies available)` : item.product.stock > 0 ? `Low Stock (${item.product.stock} copies left)` : 'Out of Stock' %>
                  </span>
                </div>
                <div class="col-md-2 col-6 text-md-center">
                  <div class="quantity-selector d-flex align-items-center">
                    <button class="btn btn-sm btn-outline-dark quantity-btn">-</button>
                    <input type="number" class="form-control form-control-sm mx-2 text-center quantity-input" value="<%= item.quantity %>" min="1" max="<%= Math.min(5, item.product.stock) %>" style="width: 50px;" />
                    <button class="btn btn-sm btn-outline-dark quantity-btn">+</button>
                  </div>
                </div>
                <div class="col-md-2 col-6 text-end">
                  <div class="d-flex flex-column align-items-end">
                    <% if (item.product.discountPercentage > 0) { %>
                      <span class="original-price">₹<%= item.product.originalPrice.toFixed(2) %></span>
                      <span class="discounted-price fw-bold">₹<%= (item.quantity * item.product.finalPrice).toFixed(2) %></span>
                    <% } else { %>
                      <span class="fw-bold">₹<%= (item.quantity * item.product.finalPrice).toFixed(2) %></span>
                    <% } %>
                    <button class="btn btn-link text-danger p-0 small text-decoration-none remove-item">Remove</button>
                  </div>
                </div>
              </div>
            </div>
          <% }) %>
        </div>

        <!-- Continue Shopping -->
        <div class="mt-4">
          <a href="/shopPage" class="text-dark d-flex align-items-center text-decoration-none">
            <i class="ri-arrow-left-line me-2"></i> Continue Shopping
          </a>
        </div>
      </div>

      <!-- Order Summary -->
      <div class="col-lg-4">
        <div class="order-summary bg-white p-4 rounded shadow-sm <%= cartItems.length === 0 ? 'd-none' : '' %>" id="orderSummary">
          <h2 class="fs-4 fw-bold mb-4">Order Summary</h2>
          
          <!-- Subtotal -->
          <div class="d-flex justify-content-between mb-3">
            <span>Subtotal (<%= cartItems.reduce((sum, item) => sum + item.quantity, 0) %> items)</span>
            <span class="fw-semibold">₹<%= (parseFloat(totalAmount) + parseFloat(totalDiscount)).toFixed(2) %></span>
          </div>
          
          <!-- Discount -->
          <% if (totalDiscount > 0) { %>
            <div class="d-flex justify-content-between mb-3 text-success">
              <span>Discount</span>
              <span class="fw-semibold">-₹<%= totalDiscount %></span>
            </div>
          <% } %>
          
          <!-- Shipping -->
          <div class="d-flex justify-content-between mb-3">
            <span>Delivery</span>
            <span class="fw-semibold">
              <% 
                const cartSubtotal = parseFloat(totalAmount) + parseFloat(totalDiscount);
                const deliveryCharge = cartSubtotal >= 1000 ? 0 : 50;
              %>
              <% if (deliveryCharge > 0) { %>
                ₹<%= deliveryCharge.toFixed(2) %>
              <% } else { %>
                <span class="text-success">FREE</span>
              <% } %>
            </span>
          </div>
          
          <% if (deliveryCharge > 0) { %>
            <div class="alert alert-info small mb-3">
              <i class="ri-truck-line me-1"></i>
              Add ₹<%= (1000 - cartSubtotal).toFixed(2) %> more to get FREE delivery!
            </div>
          <% } else { %>
            <div class="alert alert-success small mb-3">
              <i class="ri-check-line me-1"></i>
              Congratulations! You qualify for FREE delivery.
            </div>
          <% } %>
          
          <hr class="my-3">
          
          <!-- Total -->
          <div class="d-flex justify-content-between align-items-center mb-4">
            <span class="fs-5 fw-bold">Total</span>
            <span class="fs-5 fw-bold">₹<%= (parseFloat(totalAmount) + deliveryCharge).toFixed(2) %></span>
          </div>
          
          <!-- Checkout Button -->
          <button id="proceedToCheckoutBtn" class="btn btn-dark w-100 py-3 fw-medium">
            <span class="btn-text">Proceed to Checkout</span>
            <span class="btn-spinner d-none">
              <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
              Validating Stock...
            </span>
          </button>
          
          <!-- Payment Methods -->
          <div class="payment-methods mt-3 text-center">
            <p class="text-muted small mb-2">We accept</p>
            <div class="d-flex justify-content-center gap-2">
              <div class="payment-icon"><i class="ri-visa-line"></i></div>
              <div class="payment-icon"><i class="ri-mastercard-line"></i></div>
              <div class="payment-icon"><i class="ri-paypal-line"></i></div>
              <div class="payment-icon"><i class="ri-apple-line"></i></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- You May Also Like Section -->
<section class="py-5 bg-light">
  <div class="container">
    <h2 class="fs-2 fw-bold mb-4">You May Also Like</h2>
    <div class="row g-4">
      <% relatedProducts.forEach(product => { %>
        <div class="col-6 col-md-3">
          <div class="product-card bg-white h-100">
            <div class="product-image-container">
              <% 
                const now = new Date();
                const createdAt = new Date(product.createdAt);
                const diffDays = (now - createdAt) / (1000 * 60 * 60 * 24);
                const isNew = diffDays <= 30;
              %>
              <% if (isNew) { %>
                <span class="product-tag">New</span>
              <% } %>
              
              <% if (product.activeOffer && product.discountPercentage > 0) { %>
                <span class="position-absolute top-0 end-0 offer-badge"><%= product.discountPercentage %>% OFF</span>
              <% } %>
              
              <a href="/products/<%= product._id %>" class="text-decoration-none">
                <img src="<%= product.mainImage || '/api/placeholder/600/800?type=book' %>" alt="<%= product.title %>" class="product-image" />
              </a>
            </div>
            <div class="p-3">
              <h3 class="fs-5 fw-semibold mb-1">
                <a href="/products/<%= product._id %>" class="text-dark text-decoration-none"><%= product.title %></a>
              </h3>
              <p class="text-muted small mb-2"><%= product.author %></p>
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <% if (product.activeOffer && product.discountPercentage > 0) { %>
                    <span class="original-price">₹<%= product.originalPrice.toFixed(2) %></span>
                    <span class="fw-bold">₹<%= product.finalPrice.toFixed(2) %></span>
                  <% } else { %>
                    <span class="fw-bold">₹<%= product.finalPrice.toFixed(2) %></span>
                  <% } %>
                  <span class="stock-status <%= product.stock > 10 ? 'in-stock' : product.stock > 0 ? 'low-stock' : 'out-of-stock' %>">
                    <i class="ri-<%= product.stock > 10 ? 'checkbox-circle-line' : product.stock > 0 ? 'alert-line' : 'close-circle-line' %> me-1"></i>
                    <%= product.stock > 10 ? 'In Stock' : product.stock > 0 ? 'Low Stock' : 'Out of Stock' %>
                  </span>
                </div>
                <button class="add-to-cart border-0" data-product-id="<%= product._id %>">
                  <i class="ri-add-line"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      <% }) %>
    </div>
  </div>
</section>

<%- include("../partials/user/footer") %>

<style>
  /* Existing styles unchanged */
  body {
    font-family: "Inter", sans-serif;
    color: #1a1a1a;
    background-color: #f9f9f9;
  }
  
  .cart-item {
    transition: all 0.2s ease;
  }
  
  .cart-item:hover {
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
  }
  
  .quantity-btn {
    width: 28px;
    height: 28px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .quantity-btn:focus {
    box-shadow: none;
  }
  
  .form-control:focus {
    box-shadow: none;
    border-color: #000;
  }
  
  .btn-dark {
    background-color: #000;
    border-color: #000;
  }
  
  .btn-dark:hover {
    background-color: #333;
    border-color: #333;
  }
  
  .btn-outline-dark:hover {
    background-color: #000;
    border-color: #000;
  }
  
  .product-image-container {
    height: 16rem;
    overflow: hidden;
    position: relative;
  }
  
  .product-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: top;
    transition: transform 0.5s ease;
  }
  
  .product-card:hover .product-image {
    transform: scale(1.05);
  }
  
  .product-tag {
    position: absolute;
    top: 0.75rem;
    left: 0.75rem;
    z-index: 10;
    background-color: #000;
    color: #fff;
    font-size: 0.75rem;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
  }
  
  .add-to-cart {
    width: 2.5rem;
    height: 2.5rem;
    border-radius: 9999px;
    background-color: #000;
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
  }
  
  .add-to-cart:hover {
    background-color: #333;
  }
  
  .payment-icon {
    width: 2rem;
    height: 2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #6b7280;
  }
  
  .stock-status {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 0.25rem;
    font-size: 0.875rem;
    font-weight: 500;
    margin-top: 0.5rem;
  }
  
  .in-stock {
    background-color: #ecfdf5;
    color: #047857;
  }
  
  .low-stock {
    background-color: #fffbeb;
    color: #b45309;
  }
  
  .out-of-stock {
    background-color: #fef2f2;
    color: #b91c1c;
  }
  
  #orderSummary.fixed {
    position: fixed;
    top: 80px;
    width: inherit;
    max-width: inherit;
  }
  
  @media (max-width: 767.98px) {
    .quantity-selector {
      justify-content: flex-start;
    }
    
    #orderSummary.fixed {
      position: fixed;
      top: 80px;
      z-index: 100;
      transition: all 0.2s ease;
    }
    
    .col-lg-4 {
      position: relative;
    }
    
    @media (max-width: 991.98px) {
      #orderSummary.fixed {
        position: static !important;
        width: 100% !important;
      }
    }
    
    .stock-status {
      padding: 0.15rem 0.5rem;
      font-size: 0.75rem;
    }
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  // DOM Elements
  const clearCartBtn = document.querySelector('#clearCartBtn');
  const emptyCart = document.querySelector('.empty-cart');
  const cartItemsContainer = document.querySelector('.cart-items');
  const orderSummary = document.querySelector('#orderSummary');
  const cartCountElement = document.querySelector('.cart-count');
  
  // Store initial values for all quantity inputs
  document.querySelectorAll('.quantity-input').forEach(input => {
    input.dataset.previousValue = input.value;
  });

  // Clear cart
  if (clearCartBtn) {
    clearCartBtn.addEventListener('click', clearCart);
  }

  // Set up event listeners for all cart items
  setupCartItemHandlers();

  // Add to cart for related products
  document.querySelectorAll('.add-to-cart').forEach(button => {
    button.addEventListener('click', function() {
      addToCart(this.dataset.productId);
    });
  });

  // Fixed order summary on scroll
  window.addEventListener('scroll', handleOrderSummaryPosition);

  // Main Functions
  async function clearCart() {
    // Show confirmation dialog
    const result = await Swal.fire({
      title: 'Clear Cart?',
      text: 'Are you sure you want to remove all items from your cart? This action cannot be undone.',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#dc3545',
      cancelButtonColor: '#6c757d',
      confirmButtonText: 'Yes, clear it!',
      cancelButtonText: 'Cancel',
      reverseButtons: true
    });

    // If user confirmed, proceed with clearing
    if (result.isConfirmed) {
      try {
        const response = await fetch('/cart/clear', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin'
        });

        if (!response.ok) {
          throw new Error(`Server responded with ${response.status}: ${response.statusText}`);
        }

        const apiResult = await response.json();

        if (apiResult.success) {
          emptyCart.classList.remove('d-none');
          cartItemsContainer.classList.add('d-none');
          orderSummary.classList.add('d-none');
          updateCartCount(apiResult.cartCount);

          showNotification('success', 'Cart cleared successfully!');
        } else {
          showNotification('error', apiResult.message || 'Failed to clear cart');
        }
      } catch (error) {
        console.error('Clear cart error:', error);
        showNotification('error', 'Error clearing cart');
      }
    }
  }

  function setupCartItemHandlers() {
    const cartItems = document.querySelectorAll('.cart-item');
    
    cartItems.forEach(item => {
      const productId = item.dataset.productId;
      const minusBtn = item.querySelector('.quantity-btn:first-child');
      const plusBtn = item.querySelector('.quantity-btn:last-child');
      const quantityInput = item.querySelector('.quantity-input');
      const removeBtn = item.querySelector('.remove-item');

      if (!quantityInput) {
        return;
      }

      // Preserve initial values
      quantityInput.dataset.previousValue = quantityInput.value;
      
      // Debounce timer
      let updateTimeout;

      minusBtn && minusBtn.addEventListener('click', function() {
        let value = parseInt(quantityInput.value);
        if (value > 1) {
          quantityInput.value = value - 1;
          clearTimeout(updateTimeout);
          updateTimeout = setTimeout(() => {
            updateCartItem(productId, parseInt(quantityInput.value), item);
          }, 300);
        }
      });

      plusBtn && plusBtn.addEventListener('click', function() {
        let value = parseInt(quantityInput.value);
        const maxValue = parseInt(quantityInput.getAttribute('max') || '999');
        
        if (value >= maxValue) {
          const isQuantityLimit = maxValue === 5;
          const message = isQuantityLimit
            ? `Maximum 5 items allowed per product`
            : `Only ${maxValue} items in stock`;
          showNotification('error', message);
          return;
        }

        quantityInput.value = value + 1;
        clearTimeout(updateTimeout);
        updateTimeout = setTimeout(() => {
          updateCartItem(productId, parseInt(quantityInput.value), item);
        }, 300);
      });

      quantityInput && quantityInput.addEventListener('change', function() {
        let value = parseInt(this.value);
        const maxValue = parseInt(this.getAttribute('max') || '999');
        
        // Validate input
        if (isNaN(value) || value < 1) {
          value = 1;
        } else if (value > maxValue) {
          value = maxValue;
          this.value = value;
          showNotification('error', `Only ${maxValue} items in stock`);
          return;
        }
        
        this.value = value;
        clearTimeout(updateTimeout);
        updateTimeout = setTimeout(() => {
          updateCartItem(productId, value, item);
        }, 300);
      });

      removeBtn && removeBtn.addEventListener('click', function() {
        removeCartItem(productId, item);
      });
    });
  }

  async function updateCartItem(productId, quantity, item) {
    try {
      item.classList.add('updating');
      
      const quantityInput = item.querySelector('.quantity-input');
      const previousValue = quantityInput.dataset.previousValue;
      
      const response = await fetch('/cart/update', {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin',
        body: JSON.stringify({ 
          productId: productId, 
          quantity: quantity 
        })
      });
      
      if (!response.ok) {
        throw new Error(`Server responded with ${response.status}: ${response.statusText}`);
      }
      
      const result = await response.json();

      if (result.success) {
        quantityInput.dataset.previousValue = quantity;
        
        // Update price displays with correct values
        const priceElement = item.querySelector('.discounted-price') || item.querySelector('.fw-bold');
        const originalPriceElement = item.querySelector('.original-price');
        
        if (result.hasOffer && result.offerValid) {
          // Show discounted pricing
          if (priceElement) {
            priceElement.textContent = `₹${result.itemTotal.toFixed(2)}`;
            priceElement.classList.add('discounted-price');
          }
          
          if (originalPriceElement) {
            originalPriceElement.textContent = `₹${result.originalItemTotal.toFixed(2)}`;
            originalPriceElement.style.display = 'inline';
          } else if (priceElement) {
            // Create original price element if it doesn't exist
            const originalSpan = document.createElement('span');
            originalSpan.className = 'original-price';
            originalSpan.textContent = `₹${result.originalItemTotal.toFixed(2)}`;
            priceElement.parentNode.insertBefore(originalSpan, priceElement);
          }
          
          // Update or add offer badge
          let offerBadge = item.querySelector('.offer-badge');
          if (!offerBadge && result.discountPercentage > 0) {
            offerBadge = document.createElement('span');
            offerBadge.className = 'position-absolute top-0 end-0 offer-badge';
            const imageContainer = item.querySelector('.position-relative');
            if (imageContainer) {
              imageContainer.appendChild(offerBadge);
            }
          }
          if (offerBadge) {
            offerBadge.textContent = `${result.discountPercentage}% OFF`;
          }
          
          // Update offer title
          let offerTitle = item.querySelector('.offer-title');
          if (!offerTitle && result.offerTitle) {
            offerTitle = document.createElement('p');
            offerTitle.className = 'offer-title mt-1';
            const productInfo = item.querySelector('.col-md-6');
            if (productInfo) {
              productInfo.appendChild(offerTitle);
            }
          }
          if (offerTitle && result.offerTitle) {
            offerTitle.innerHTML = `<i class="ri-price-tag-3-line"></i> ${result.offerTitle}`;
          }
        } else {
          // No offer or offer expired - show regular pricing
          if (priceElement) {
            priceElement.textContent = `₹${result.originalItemTotal.toFixed(2)}`;
            priceElement.classList.remove('discounted-price');
          }
          
          if (originalPriceElement) {
            originalPriceElement.style.display = 'none';
          }
          
          // Remove offer badge
          const offerBadge = item.querySelector('.offer-badge');
          if (offerBadge) {
            offerBadge.remove();
          }
          
          // Remove offer title
          const offerTitle = item.querySelector('.offer-title');
          if (offerTitle) {
            offerTitle.remove();
          }
        }
        
        // Update order summary with correct discount amount
        if (typeof result.totalAmount === 'number') {
          updateOrderSummaryDOM(result.totalAmount, result.cartCount, result.totalDiscount || 0);
        }
        
        if (result.cartCount !== undefined) {
          updateCartCount(result.cartCount);
        } else {
          recalculateCartCount();
        }

        // Show appropriate success message
        let message = result.message || 'Cart updated successfully';
        if (result.offerExpired) {
          message = 'Cart updated - offer has expired';
          showNotification('warning', message);
          // Add visual indication of expired offer
          const offerBadge = item.querySelector('.offer-badge');
          if (offerBadge) {
            offerBadge.classList.add('offer-expired');
          }
        } else if (result.priceChanged) {
          message = 'Cart updated - price has been updated';
          showNotification('info', message);
          // Add visual indication of price change
          const priceContainer = item.querySelector('.col-md-2:last-child');
          if (priceContainer) {
            priceContainer.classList.add('price-updated');
            setTimeout(() => {
              priceContainer.classList.remove('price-updated');
            }, 2000);
          }
        } else {
          showNotification('success', message);
        }
      } else {
        // Revert quantity on failure
        quantityInput.value = previousValue;
        showNotification('error', result.message || 'Failed to update cart');
      }
    } catch (error) {
      console.error('Cart update error:', error);
      const quantityInput = item.querySelector('.quantity-input');
      quantityInput.value = quantityInput.dataset.previousValue;
      showNotification('error', 'Error communicating with server');
    } finally {
      item.classList.remove('updating');
    }
  }

  async function removeCartItem(productId, item) {
    try {
      item.style.opacity = '0.5';
      
      const response = await fetch('/cart/remove', {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin',
        body: JSON.stringify({ productId })
      });
      
      if (!response.ok) {
        throw new Error(`Server responded with ${response.status}: ${response.statusText}`);
      }
      
      const result = await response.json();

      if (result.success) {
        item.style.opacity = '0';
        setTimeout(() => {
          item.remove();
          
          if (typeof result.totalAmount === 'number') {
            updateOrderSummaryDOM(result.totalAmount, result.cartCount, result.totalDiscount || 0);
          }
          
          updateCartCount(result.cartCount);

          if (document.querySelectorAll('.cart-item').length === 0) {
            emptyCart.classList.remove('d-none');
            cartItemsContainer.classList.add('d-none');
            orderSummary.classList.add('d-none');
          }

          showNotification('success', result.message || 'Item removed from cart');
        }, 300);
      } else {
        item.style.opacity = '1';
        showNotification('error', result.message || 'Failed to remove item');
      }
    } catch (error) {
      console.error('Remove item error:', error);
      item.style.opacity = '1';
      showNotification('error', 'Error removing item');
    }
  }

  async function addToCart(productId) {
    try {
      const response = await fetch('/cart/add', {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin',
        body: JSON.stringify({ productId, quantity: 1 })
      });
      
      if (!response.ok) {
        throw new Error(`Server responded with ${response.status}: ${response.statusText}`);
      }
      
      const result = await response.json();

      if (result.success) {
        updateCartCount(result.cartCount);
        showNotification('success', result.message || 'Item added to cart');
      } else {
        showNotification('error', result.message || 'Failed to add item to cart');
      }
    } catch (error) {
      console.error('Add to cart error:', error);
      showNotification('error', 'Error adding to cart');
    }
  }

  // Helper Functions
  function updateCartCount(count) {
    if (cartCountElement) {
      cartCountElement.textContent = count;
      cartCountElement.dataset.count = count;
    }
  }

  function recalculateCartCount() {
    if (cartCountElement) {
      // Count the number of unique items (cart items), not total quantity
      const count = document.querySelectorAll('.cart-item').length;
      
      cartCountElement.textContent = count;
      cartCountElement.dataset.count = count;
    }
  }

  function updateOrderSummaryDOM(totalAmount, cartCount, totalDiscount) {
    // Update subtotal (before discount)
    const subtotalElement = findElement([
      '#orderSummary .d-flex:first-child .fw-semibold',
      '#orderSummary .d-flex:nth-child(1) .fw-semibold',
      '#orderSummary .d-flex .fw-semibold'
    ]);
    
    if (subtotalElement) {
      const originalSubtotal = totalAmount + (totalDiscount || 0);
      subtotalElement.textContent = `₹${originalSubtotal.toFixed(2)}`;
    }
    
    // Handle discount section - this is the key fix
    let discountRow = document.querySelector('#orderSummary .text-success');
    
    if (totalDiscount && totalDiscount > 0) {
      if (discountRow) {
        // Update existing discount row
        const discountElement = discountRow.querySelector('.fw-semibold');
        if (discountElement) {
          discountElement.textContent = `-₹${totalDiscount.toFixed(2)}`;
        }
      } else {
        // Create new discount row if it doesn't exist
        const subtotalRow = document.querySelector('#orderSummary .d-flex:first-child');
        if (subtotalRow) {
          const discountRowHTML = `
            <div class="d-flex justify-content-between mb-3 text-success">
              <span>Discount</span>
              <span class="fw-semibold">-₹${totalDiscount.toFixed(2)}</span>
            </div>
          `;
          subtotalRow.insertAdjacentHTML('afterend', discountRowHTML);
        }
      }
    } else {
      // Remove discount row if no discount
      if (discountRow) {
        discountRow.remove();
      }
    }
    
    // Alternative approach: Find discount by content
    if (totalDiscount && totalDiscount > 0) {
      const allRows = document.querySelectorAll('#orderSummary .d-flex');
      let discountFound = false;
      
      allRows.forEach(row => {
        const firstSpan = row.querySelector('span:first-child');
        if (firstSpan && firstSpan.textContent.trim() === 'Discount') {
          const discountElement = row.querySelector('.fw-semibold');
          if (discountElement) {
            discountElement.textContent = `-₹${totalDiscount.toFixed(2)}`;
            discountFound = true;
          }
        }
      });
      
      if (!discountFound) {
        rebuildOrderSummary(totalAmount, cartCount, totalDiscount);
        return;
      }
    }
    
    // Update delivery charge - need to find the correct delivery row
    const deliveryRow = Array.from(document.querySelectorAll('#orderSummary .d-flex')).find(row => {
      const span = row.querySelector('span:first-child');
      return span && span.textContent.trim() === 'Delivery';
    });
    
    const originalSubtotal = totalAmount + (totalDiscount || 0);
    const deliveryCharge = originalSubtotal >= 1000 ? 0 : 50;
    
    if (deliveryRow) {
      const deliveryElement = deliveryRow.querySelector('.fw-semibold');
      if (deliveryElement) {
        if (deliveryCharge > 0) {
          deliveryElement.innerHTML = `₹${deliveryCharge.toFixed(2)}`;
        } else {
          deliveryElement.innerHTML = '<span class="text-success">FREE</span>';
        }
      }
    }
    
    // Update delivery alert
    const deliveryAlert = document.querySelector('#orderSummary .alert');
    if (deliveryAlert) {
      if (deliveryCharge > 0) {
        const amountNeeded = (1000 - originalSubtotal).toFixed(2);
        deliveryAlert.className = 'alert alert-info small mb-3';
        deliveryAlert.innerHTML = `<i class="ri-truck-line me-1"></i> Add ₹${amountNeeded} more to get FREE delivery!`;
      } else {
        deliveryAlert.className = 'alert alert-success small mb-3';
        deliveryAlert.innerHTML = '<i class="ri-check-line me-1"></i> Congratulations! You qualify for FREE delivery.';
      }
    }
    
    // Update total - find the total row more reliably
    const totalRow = Array.from(document.querySelectorAll('#orderSummary .d-flex')).find(row => {
      const span = row.querySelector('.fs-5.fw-bold');
      return span && span.textContent.trim() === 'Total';
    });
    
    if (totalRow) {
      const totalElement = totalRow.querySelector('.fs-5.fw-bold:last-child');
      if (totalElement) {
        const finalTotal = totalAmount + deliveryCharge;
        totalElement.textContent = `₹${finalTotal.toFixed(2)}`;
      }
    }
    
    // Update item count in subtotal
    if (cartCount !== undefined) {
      const itemCountElement = findElement([
        '#orderSummary .d-flex:first-child span:first-child',
        '#orderSummary .d-flex:nth-child(1) span:first-child'
      ]);
      
      if (itemCountElement) {
        itemCountElement.textContent = `Subtotal (${cartCount} items)`;
      }
      
      const cartItemsHeader = document.querySelector('.cart-items h2');
      if (cartItemsHeader) {
        cartItemsHeader.textContent = `Items (${cartCount})`;
      }
    }
    
    // Force a visual refresh and fallback to rebuild if needed
    if (!subtotalElement || !document.querySelector('#orderSummary .fs-5.fw-bold:last-child')) {
      rebuildOrderSummary(totalAmount, cartCount, totalDiscount);
    } else {
      orderSummary.style.display = 'none';
      orderSummary.offsetHeight;
      orderSummary.style.display = '';
    }
  }
  
  function findElement(selectors) {
    for (const selector of selectors) {
      const element = document.querySelector(selector);
      if (element) {
        return element;
      }
    }
    return null;
  }
  
  function rebuildOrderSummary(totalAmount, cartCount, totalDiscount) {
    if (!orderSummary) {
      return;
    }
    
    const originalSubtotal = totalAmount + (totalDiscount || 0);
    const deliveryCharge = originalSubtotal >= 1000 ? 0 : 50;
    const finalTotal = totalAmount + deliveryCharge;
    
    const summaryHTML = `
      <h2 class="fs-4 fw-bold mb-4">Order Summary</h2>
      
      <!-- Subtotal -->
      <div class="d-flex justify-content-between mb-3">
        <span>Subtotal (${cartCount || 0} items)</span>
        <span class="fw-semibold">₹${originalSubtotal.toFixed(2)}</span>
      </div>
      
      <!-- Discount -->
      ${(totalDiscount && totalDiscount > 0) ? `
        <div class="d-flex justify-content-between mb-3 text-success">
          <span>Discount</span>
          <span class="fw-semibold">-₹${totalDiscount.toFixed(2)}</span>
        </div>
      ` : ''}
      
      <!-- Delivery -->
      <div class="d-flex justify-content-between mb-3">
        <span>Delivery</span>
        <span class="fw-semibold">
          ${deliveryCharge > 0 ? `₹${deliveryCharge.toFixed(2)}` : '<span class="text-success">FREE</span>'}
        </span>
      </div>
      
      ${deliveryCharge > 0 ? `
        <div class="alert alert-info small mb-3">
          <i class="ri-truck-line me-1"></i>
          Add ₹${(1000 - originalSubtotal).toFixed(2)} more to get FREE delivery!
        </div>
      ` : `
        <div class="alert alert-success small mb-3">
          <i class="ri-check-line me-1"></i>
          Congratulations! You qualify for FREE delivery.
        </div>
      `}
      
      <hr class="my-3">
      
      <!-- Total -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <span class="fs-5 fw-bold">Total</span>
        <span class="fs-5 fw-bold">₹${finalTotal.toFixed(2)}</span>
      </div>
      
      <!-- Checkout Button -->
      <button id="proceedToCheckoutBtn2" class="btn btn-dark w-100 py-3 fw-medium">
        <span class="btn-text">Proceed to Checkout</span>
        <span class="btn-spinner d-none">
          <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
          Validating Stock...
        </span>
      </button>
      
      <!-- Payment Methods -->
      <div class="payment-methods mt-3 text-center">
        <p class="text-muted small mb-2">We accept</p>
        <div class="d-flex justify-content-center gap-2">
          <div class="payment-icon"><i class="ri-visa-line"></i></div>
          <div class="payment-icon"><i class="ri-mastercard-line"></i></div>
          <div class="payment-icon"><i class="ri-paypal-line"></i></div>
          <div class="payment-icon"><i class="ri-apple-line"></i></div>
        </div>
      </div>
    `;
    
    orderSummary.innerHTML = summaryHTML;
    
    // Re-attach event listener to the new checkout button
    const newCheckoutBtn = document.getElementById('proceedToCheckoutBtn2');
    if (newCheckoutBtn) {
      newCheckoutBtn.addEventListener('click', function(e) {
        e.preventDefault();
        proceedToCheckout(this);
      });
    }
  }

  function handleOrderSummaryPosition() {
    if (!orderSummary) return;
    
    const parentContainer = orderSummary.closest('.col-lg-4');
    if (!parentContainer) return;
    
    const parentRect = parentContainer.getBoundingClientRect();
    const summaryHeight = orderSummary.offsetHeight;
    const windowHeight = window.innerHeight;
    
    if (window.innerWidth >= 992) {
      if (parentRect.top < 80 && parentRect.bottom > (summaryHeight + 80)) {
        orderSummary.classList.add('fixed');
        orderSummary.style.width = parentRect.width + 'px';
        orderSummary.style.maxHeight = (windowHeight - 100) + 'px';
        orderSummary.style.overflowY = summaryHeight > (windowHeight - 100) ? 'auto' : 'visible';
      } else {
        orderSummary.classList.remove('fixed');
        orderSummary.style.width = '';
        orderSummary.style.maxHeight = '';
        orderSummary.style.overflowY = '';
      }
    } else {
      orderSummary.classList.remove('fixed');
      orderSummary.style.width = '';
      orderSummary.style.maxHeight = '';
      orderSummary.style.overflowY = '';
    }
  }

  function showNotification(type, message) {
    Swal.fire({
      toast: true,
      position: 'top-end',
      icon: type,
      title: message,
      showConfirmButton: false,
      timer: 3000
    });
  }

  // Proceed to Checkout with Stock Validation
  async function proceedToCheckout(button) {
    const btnText = button.querySelector('.btn-text');
    const btnSpinner = button.querySelector('.btn-spinner');
    
    // Show loading state
    btnText.classList.add('d-none');
    btnSpinner.classList.remove('d-none');
    button.disabled = true;
    
    try {
      const response = await fetch('/checkout/validate-stock', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        }
      });
      
      if (!response.ok) {
        throw new Error(`Server responded with ${response.status}: ${response.statusText}`);
      }
      
      const result = await response.json();
      
      if (result.success && result.valid) {
        // Stock is valid, proceed to checkout
        window.location.href = '/checkout';
      } else if (result.success && !result.valid) {
        // Stock issues found, show detailed error message
        let errorMessage = 'Stock has been updated. Please adjust your cart quantities:\n\n';
        
        if (result.stockIssues && result.stockIssues.length > 0) {
          result.stockIssues.forEach(issue => {
            if (issue.issue === 'Insufficient stock') {
              errorMessage += `• ${issue.productTitle}: You have ${issue.requestedQuantity} in cart, but only ${issue.availableStock} available\n`;
            } else {
              errorMessage += `• ${issue.productTitle}: ${issue.issue}\n`;
            }
          });
        }
        
        // Show error message using SweetAlert
        Swal.fire({
          icon: 'warning',
          title: 'Stock Updated',
          text: errorMessage,
          confirmButtonText: 'Update Cart',
          confirmButtonColor: '#000'
        }).then(() => {
          // Reload the page to show updated stock
          window.location.reload();
        });
        
      } else {
        showNotification('error', result.message || 'Error validating stock');
      }
      
    } catch (error) {
      console.error('Stock validation error:', error);
      showNotification('error', 'Error validating stock. Please try again.');
    } finally {
      // Reset button state
      btnText.classList.remove('d-none');
      btnSpinner.classList.add('d-none');
      button.disabled = false;
    }
  }

  // Add event listeners for checkout buttons
  const checkoutBtn1 = document.getElementById('proceedToCheckoutBtn');
  const checkoutBtn2 = document.getElementById('proceedToCheckoutBtn2');
  
  if (checkoutBtn1) {
    checkoutBtn1.addEventListener('click', function(e) {
      e.preventDefault();
      proceedToCheckout(this);
    });
  }
  
  if (checkoutBtn2) {
    checkoutBtn2.addEventListener('click', function(e) {
      e.preventDefault();
      proceedToCheckout(this);
    });
  }
});
</script>